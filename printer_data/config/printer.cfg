#Test
# This file contains common pin mappings for the BigTreeTech Octopus V1.
# This file contains common pin mappings for the BigTreeTech Octopus V1.
# To use this config, the firmware should be compiled for the STM32F446 with a "32KiB bootloader"
# Enable "extra low-level configuration options" and select the "12MHz crystal" as clock reference

# after running "make", copy the generated "klipper/out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the OctoPus with that SD card.

# See docs/Config_Reference.md for a description of parameters.

#####################################################################
#   Includes
#####################################################################
[include shell_command.cfg]
[include mainsail.cfg]
[include sb2209_usb.cfg]
[include stealthburner_leds.cfg]
[include btt_sff.cfg]
[include adaptive_mesh.cfg]
[include voron_purge.cfg]
[include nevermore.cfg]
[include macros.cfg]
[include timelapse.cfg]
[include TEST_SPEED.cfg]
[include macros/*.cfg]

#####################################################################
# Diverses
#####################################################################

[exclude_object]

#####################################################################
# Main
#####################################################################

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
##--------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_29002D001050334636383920-if00
restart_method: command
##--------------------------------------------------------------------

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 10000             #Max 4000
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

#####################################################################
#   Probe
#########¦¦¦¦¦¦######################################################

[mcu scanner]
#canbus_uuid: 9dcc262196d7 
serial: /dev/serial/by-id/usb-Cartographer_614e_028008000F43304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 15                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01586
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 1
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 150, 150    
#    set this to the middle of your bed
speed: 500
#    movement speed of toolhead during bed mesh
horizontal_move_z: 5
#    height of scanner during bed mesh scan
mesh_min: 35, 6
#    start point of bed mesh [X, Y]
mesh_max: 240, 198
#    end point of bed mesh [X, Y]
probe_count: 50, 50
algorithm: bicubic


#####################################################################
#   Extruder
#####################################################################


[extruder]
step_pin: EBB:gpio18
dir_pin: EBB:gpio19
enable_pin: !EBB:gpio17
gear_ratio: 50:10
microsteps: 16
rotation_distance: 21.545003545 
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_cross_section: 7
heater_pin: EBB:gpio7
pullup_resistor: 2200 # 2.2K
sensor_type: EPCOS 100K B57560G104F
sensor_pin: EBB:gpio26
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 280



#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  B Stepper - Left
##  Connected to MOTOR_0
##  Endstop connected to DIAG_0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  #set to 400 for 0.9 degree stepper
endstop_pin: EBB:gpio13
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 75   #Max 100
homing_retract_dist: 5
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PC4
interpolate: false
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0

##  A Stepper - Right
##  Connected to MOTOR_1
##  Endstop connected to DIAG_1
[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  #set to 400 for 0.9 degree stepper
endstop_pin: PG9
position_min: 0
position_endstop: 305
position_max: 305
homing_speed: 75  #Max 100
homing_retract_dist: 5
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_y]
uart_pin: PD11
interpolate: false
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0
 



#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA3
sensor_type:Generic 3950
sensor_pin: PF3
max_power: 1.0
min_temp: 0
max_temp: 120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769

#####################################################################
#   Fan Control
#####################################################################

[temperature_fan Octopus]
sensor_type: temperature_mcu
pin: PA8
max_temp: 80.0
target_temp: 50.0
min_temp: 0
shutdown_speed: 0.0
kick_start_time: 0.5
off_below: 0.19
max_speed: 1.0
min_speed: 0.0
control: pid
pid_Kp: 2.0
pid_Ki: 5.0
pid_Kd: 0.5
pid_deriv_time: 2.0

[temperature_fan Raspberry]
sensor_type: temperature_host
pin: PE5
max_temp: 80.0
target_temp:50.0
min_temp: 10.0
shutdown_speed: 0.0
kick_start_time: 0.5
off_below: 0.19
max_speed: 1.0
min_speed: 0.0
control: pid
pid_Kp: 2.0
pid_Ki: 5.0
pid_Kd: 0.5
pid_deriv_time: 2.0

[fan_generic Electronics_Bay]
pin: PD13


#####################################################################
#   Temperatures
#####################################################################

[temperature_sensor Raspberry_CPU]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

#[temperature_sensor Octopus_CPU]
#sensor_type: temperature_mcu
#min_temp: 0
#max_temp: 100

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[quad_gantry_level]
gantry_corners:
   -60,-10
   360,370
points:
   50,25
   50,225
   250,225
   250,25
speed: 400
horizontal_move_z: 5
retries: 6
retry_tolerance: 0.0075
max_adjust: 8

[bed_mesh]
speed: 400
mesh_min: 30,30
mesh_max: 270, 270
probe_count: 50,50
fade_start: 1.0
fade_end: 10.0
algorithm: bicubic
bicubic_tension: .2
horizontal_move_z: 10
#relative_reference_index: 12

#[probe]
#pin: EBBCan: PB6
#x_offset: 0
#y_offset: 0
#z_offset: 0
#speed: 3.0
#samples: 3
#samples_result: median
#sample_retract_dist: 3.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 5
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}
    

[safe_z_home]
##	XY Location of the Z Endstop Switch
##	Update -10,-10 to the XY coordinates of your endstop pin 
##	(such as 157,305) after going through Z Endstop Pin
##	Location Definition step.
home_xy_position:150,150
speed:100
z_hop:10

#####################################################################
#   Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
##  Connected to MOTOR_2
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32
endstop_pin: probe:z_virtual_endstop
#position_endstop: -0.5
position_max: 260
position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 0

[tmc2209 stepper_z]
uart_pin: PC6
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z1 Stepper - Rear Left
##  Connected to MOTOR_3
[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z2 Stepper - Rear Right
##  Connected to MOTOR_4
[stepper_z2]
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z3 Stepper - Front Right
##  Connected to MOTOR_5
[stepper_z3]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z3]
uart_pin: PE4
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.859
#*# pid_ki = 1.112
#*# pid_kd = 150.301
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.034821, 0.029648, 0.030205, 0.032790, 0.037179, 0.042661, 0.037757, 0.032097, 0.028023, 0.028229, 0.029557, 0.025392, 0.026782, 0.025502, 0.027251, 0.026008, 0.029028, 0.025537, 0.025753, 0.025481, 0.025889, 0.028513, 0.031623, 0.032263, 0.035431, 0.037066
#*# 	  0.038781, 0.031220, 0.027255, 0.026504, 0.029666, 0.036207, 0.036670, 0.030292, 0.026632, 0.025405, 0.027144, 0.028090, 0.025812, 0.026448, 0.026473, 0.027533, 0.027243, 0.025617, 0.026963, 0.026555, 0.027098, 0.030613, 0.031654, 0.033339, 0.034913, 0.035388
#*# 	  0.031177, 0.036708, 0.033664, 0.023898, 0.022054, 0.024867, 0.029545, 0.035040, 0.032740, 0.028009, 0.025126, 0.020537, 0.021932, 0.021671, 0.024049, 0.024672, 0.023985, 0.023310, 0.022476, 0.021851, 0.023644, 0.024743, 0.027803, 0.028075, 0.032284, 0.035866
#*# 	  0.022474, 0.031212, 0.028428, 0.019324, 0.017782, 0.018515, 0.021190, 0.026216, 0.030061, 0.028032, 0.024175, 0.018736, 0.017566, 0.018002, 0.021516, 0.022083, 0.020833, 0.019910, 0.020840, 0.021408, 0.021502, 0.024081, 0.024845, 0.028923, 0.030307, 0.030941
#*# 	  0.013748, 0.015553, 0.026527, 0.024842, 0.020773, 0.016551, 0.015938, 0.018037, 0.018189, 0.020141, 0.025722, 0.023554, 0.020451, 0.015174, 0.014823, 0.015863, 0.015066, 0.015436, 0.015435, 0.014462, 0.015610, 0.016829, 0.020330, 0.020126, 0.024041, 0.026756
#*# 	  0.009985, 0.007507, 0.013028, 0.019400, 0.018079, 0.012825, 0.011584, 0.012281, 0.011199, 0.011051, 0.014437, 0.017190, 0.018527, 0.018152, 0.013266, 0.012017, 0.011382, 0.012244, 0.012362, 0.013209, 0.013877, 0.015712, 0.014130, 0.019130, 0.020376, 0.025053
#*# 	  0.008931, 0.009840, 0.007468, 0.005450, 0.010772, 0.012972, 0.013567, 0.009893, 0.008992, 0.008260, 0.007774, 0.007964, 0.006197, 0.009633, 0.011659, 0.013636, 0.012166, 0.011166, 0.009203, 0.009852, 0.011011, 0.010596, 0.010955, 0.014590, 0.022518, 0.026670
#*# 	  0.009852, 0.007098, 0.003628, 0.000929, 0.001963, 0.003022, 0.007253, 0.007121, 0.006259, 0.005351, 0.004632, 0.004346, 0.004013, 0.004211, 0.007599, 0.010355, 0.012490, 0.012801, 0.015500, 0.014967, 0.015250, 0.015685, 0.018977, 0.022186, 0.020022, 0.018230
#*# 	  0.013858, 0.015283, 0.013476, 0.010600, 0.010394, 0.008752, 0.009684, 0.011243, 0.012770, 0.015345, 0.010779, 0.010432, 0.010781, 0.011477, 0.012478, 0.015184, 0.015730, 0.014655, 0.015616, 0.019104, 0.017799, 0.015979, 0.014560, 0.011305, 0.014085, 0.016860
#*# 	  0.002321, 0.004830, 0.004238, 0.001892, 0.002014, 0.004236, 0.005365, 0.006224, 0.008704, 0.011793, 0.010914, 0.009984, 0.006153, 0.005560, 0.007196, 0.012788, 0.011559, 0.011494, 0.009483, 0.012622, 0.014457, 0.015738, 0.016647, 0.017733, 0.017468, 0.020719
#*# 	  -0.000718, -0.000348, 0.005682, 0.001766, -0.000881, -0.001377, 0.000630, 0.000934, 0.001732, 0.000600, 0.005117, 0.008953, 0.010444, 0.009498, 0.007709, 0.007370, 0.007192, 0.008508, 0.006247, 0.007637, 0.008334, 0.008536, 0.007977, 0.011492, 0.017792, 0.025630
#*# 	  0.000671, -0.001121, 0.001604, 0.001507, 0.000625, -0.000779, 0.000283, 0.000179, 0.000317, 0.000795, 0.001486, 0.004208, 0.005688, 0.007207, 0.008854, 0.009760, 0.009360, 0.010463, 0.009887, 0.011511, 0.013732, 0.014948, 0.018797, 0.021383, 0.020477, 0.018553
#*# 	  0.006463, 0.003907, 0.003737, 0.001983, 0.004420, 0.003224, 0.002779, 0.002668, 0.001808, 0.003328, 0.003562, 0.004573, 0.006021, 0.007991, 0.005803, 0.009168, 0.009756, 0.013283, 0.013385, 0.016153, 0.014855, 0.015446, 0.013996, 0.013126, 0.012669, 0.013658
#*# 	  0.006182, 0.005002, 0.004744, 0.005523, 0.009127, 0.010558, 0.009698, 0.007751, 0.006297, 0.008312, 0.008367, 0.009473, 0.011139, 0.011319, 0.010599, 0.009481, 0.008450, 0.011706, 0.012959, 0.013549, 0.012019, 0.010925, 0.010726, 0.011849, 0.009868, 0.011028
#*# 	  0.000855, -0.001496, -0.004040, -0.004254, -0.001222, 0.004167, 0.008465, 0.003886, 0.002885, 0.003245, 0.004311, 0.003151, 0.003443, 0.002219, 0.003407, 0.004250, 0.003309, 0.005550, 0.004266, 0.005408, 0.003827, 0.008358, 0.012974, 0.019448, 0.021028, 0.023543
#*# 	  0.006657, 0.001457, -0.004482, -0.005109, -0.000796, 0.006540, 0.008232, 0.003648, 0.000539, 0.001452, 0.002880, 0.002558, 0.003974, 0.004097, 0.006790, 0.006307, 0.005705, 0.006727, 0.007586, 0.006660, 0.006416, 0.008046, 0.011119, 0.016698, 0.018742, 0.020879
#*# 	  0.007452, 0.011477, 0.009149, 0.000018, 0.000990, 0.003746, 0.009786, 0.014793, 0.010833, 0.007256, 0.005261, 0.006883, 0.006490, 0.006949, 0.007172, 0.007901, 0.006689, 0.008830, 0.009108, 0.009674, 0.008211, 0.009159, 0.009448, 0.010627, 0.014250, 0.017585
#*# 	  0.006956, 0.013074, 0.012051, 0.004665, 0.003200, 0.005876, 0.009646, 0.015958, 0.017922, 0.013655, 0.011001, 0.008760, 0.007220, 0.008846, 0.009954, 0.010062, 0.010705, 0.010985, 0.011939, 0.010705, 0.012498, 0.011598, 0.015642, 0.015850, 0.016221, 0.017546
#*# 	  0.006405, 0.007737, 0.016683, 0.018687, 0.015247, 0.008820, 0.009815, 0.012126, 0.015864, 0.021660, 0.022422, 0.019128, 0.012615, 0.012084, 0.010040, 0.011547, 0.013957, 0.013770, 0.013908, 0.016379, 0.015216, 0.013706, 0.013520, 0.016590, 0.015729, 0.018425
#*# 	  0.009942, 0.010394, 0.015759, 0.019534, 0.016784, 0.011815, 0.011083, 0.013494, 0.014020, 0.018933, 0.020820, 0.021144, 0.018626, 0.016273, 0.014236, 0.015429, 0.014517, 0.017330, 0.019153, 0.017144, 0.018871, 0.016507, 0.019149, 0.020540, 0.021020, 0.023756
#*# 	  0.014255, 0.013319, 0.012310, 0.017304, 0.024075, 0.022865, 0.019724, 0.016009, 0.016039, 0.016192, 0.017256, 0.016912, 0.016732, 0.018027, 0.019668, 0.018879, 0.015948, 0.017154, 0.015473, 0.016600, 0.017270, 0.018805, 0.018096, 0.022147, 0.025507, 0.028371
#*# 	  0.014067, 0.013587, 0.011417, 0.013718, 0.017199, 0.021536, 0.021459, 0.018440, 0.016982, 0.017497, 0.015031, 0.015478, 0.012314, 0.014009, 0.017222, 0.019086, 0.019838, 0.020824, 0.023236, 0.023258, 0.025479, 0.026578, 0.029675, 0.028734, 0.025594, 0.025073
#*# 	  0.014029, 0.015697, 0.018088, 0.016567, 0.018227, 0.018954, 0.022942, 0.027416, 0.028909, 0.026212, 0.022233, 0.020025, 0.019720, 0.019288, 0.019571, 0.018713, 0.017934, 0.019128, 0.019031, 0.021828, 0.022947, 0.025635, 0.026085, 0.026878, 0.025667, 0.027136
#*# 	  0.016561, 0.016382, 0.014426, 0.015097, 0.018215, 0.019831, 0.021365, 0.026765, 0.030947, 0.032989, 0.029242, 0.025700, 0.023147, 0.024162, 0.024246, 0.023300, 0.023101, 0.023450, 0.024591, 0.024152, 0.025386, 0.026040, 0.027635, 0.027546, 0.030542, 0.034368
#*# 	  0.019208, 0.018136, 0.019164, 0.020186, 0.022591, 0.023702, 0.026120, 0.026813, 0.028478, 0.030148, 0.032644, 0.033367, 0.033984, 0.032939, 0.029943, 0.027820, 0.027554, 0.025672, 0.024502, 0.026001, 0.023795, 0.025944, 0.024909, 0.030410, 0.038632, 0.040117
#*# x_count = 26
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 90.1819
#*# max_x = 210.24800000000002
#*# min_y = 92.6314
#*# max_y = 207.77800000000002
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 55.6
#*# shaper_type_y = zv
#*# shaper_freq_y = 39.8
#*#
#*# [probe]
#*# z_offset = -0.406
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 3500
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.030
#*#
#*# [scanner model default]
#*# model_coef = 1.2905017396028269,
#*# 	1.7203222473054083,
#*# 	0.7576251341738619,
#*# 	0.2369916907534665,
#*# 	0.4219630464755113,
#*# 	0.8480363981947698,
#*# 	-0.25365927522377185,
#*# 	-0.8481022152401332,
#*# 	0.332692089957961,
#*# 	0.49345972703895385
#*# model_domain = 3.119238151424412e-07,3.3563012338234106e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 28.158560
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
