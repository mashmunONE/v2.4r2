#Test
# This file contains common pin mappings for the BigTreeTech Octopus V1.
# This file contains common pin mappings for the BigTreeTech Octopus V1.
# To use this config, the firmware should be compiled for the STM32F446 with a "32KiB bootloader"
# Enable "extra low-level configuration options" and select the "12MHz crystal" as clock reference

# after running "make", copy the generated "klipper/out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the OctoPus with that SD card.

# See docs/Config_Reference.md for a description of parameters.

#####################################################################
#   Includes
#####################################################################
[include shell_command.cfg]
[include mainsail.cfg]
[include SB2240_can.cfg]
[include stealthburner_leds.cfg]
[include adaptive_mesh.cfg]
[include voron_purge.cfg]
[include nevermore.cfg]
[include macros.cfg]
[include timelapse.cfg]
[include TEST_SPEED.cfg]
[include macros/*.cfg]
#####################################################################
# Diverses
#####################################################################

[exclude_object]

#####################################################################
# Main
#####################################################################

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
##--------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_29002D001050334636383920-if00
restart_method: command
##--------------------------------------------------------------------

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 10000             #Max 4000
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

#####################################################################
#   Probe
#########¦¦¦¦¦¦######################################################

[mcu scanner]
canbus_uuid: 9dcc262196d7 
#serial: /dev/serial/by-id/usb-cartographer_cartographer_
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 15                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01586
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 1
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 150, 150    
#    set this to the middle of your bed
speed: 500
#    movement speed of toolhead during bed mesh
horizontal_move_z: 5
#    height of scanner during bed mesh scan
mesh_min: 35, 6
#    start point of bed mesh [X, Y]
mesh_max: 240, 198
#    end point of bed mesh [X, Y]
probe_count: 50, 50
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105


#####################################################################
#   Extruder
#####################################################################

[extruder]
step_pin: EBBCan: PD0
dir_pin: EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 16
rotation_distance: 22.840
gear_ratio: 50:10
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan: PB13
sensor_type: EPCOS 100K B57560G104F
sensor_pin: EBBCan: PA3
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 300
max_extrude_cross_section: 7
pressure_advance: 0.01
max_extrude_only_velocity: 500
max_extrude_only_distance: 101.0

[tmc2240 extruder]
cs_pin: EBBCan: PA15
spi_software_sclk_pin: EBBCan: PB10
spi_software_mosi_pin: EBBCan: PB11
spi_software_miso_pin: EBBCan: PB2
driver_TPFD: 0
run_current: 0.65
stealthchop_threshold: 999999




#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  B Stepper - Left
##  Connected to MOTOR_0
##  Endstop connected to DIAG_0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  #set to 400 for 0.9 degree stepper
endstop_pin: EBBCan: PB5
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 75   #Max 100
homing_retract_dist: 5
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PC4
interpolate: false
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0

##  A Stepper - Right
##  Connected to MOTOR_1
##  Endstop connected to DIAG_1
[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  #set to 400 for 0.9 degree stepper
endstop_pin: PG9
position_min: 0
position_endstop: 305
position_max: 305
homing_speed: 75  #Max 100
homing_retract_dist: 5
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_y]
uart_pin: PD11
interpolate: false
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0
 



#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA3
sensor_type:Generic 3950
sensor_pin: PF3
max_power: 1.0
min_temp: 0
max_temp: 120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769

#####################################################################
#   Fan Control
#####################################################################

[temperature_fan Octopus]
sensor_type: temperature_mcu
pin: PA8                    
max_temp: 80.0                
target_temp: 40.0            
min_temp: 0
shutdown_speed: 0.0
kick_start_time: 0.5
off_below: 0.19
max_speed: 1.0
min_speed: 0.0
control: pid
pid_Kp: 2.0
pid_Ki: 5.0
pid_Kd: 0.5
pid_deriv_time: 2.0

[temperature_fan Raspberry]
sensor_type: temperature_host
pin: PA5                      
max_temp: 80.0                
target_temp: 35.0             
min_temp: 0
shutdown_speed: 0.0
kick_start_time: 0.5
off_below: 0.19
max_speed: 1.0
min_speed: 0.0
control: pid
pid_Kp: 2.0
pid_Ki: 5.0
pid_Kd: 0.5
pid_deriv_time: 2.0

#####################################################################
#   Temperatures
#####################################################################

#[temperature_sensor Raspberry]
#sensor_type: temperature_host
#min_temp: 10
#max_temp: 100

#[temperature_sensor Octopus]
#sensor_type: temperature_mcu
#min_temp: 0
#max_temp: 100



#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[quad_gantry_level]
gantry_corners:
   -60,-10
   360,370
points:
   50,25
   50,225
   250,225
   250,25
speed: 400
horizontal_move_z: 5
retries: 6
retry_tolerance: 0.0075
max_adjust: 6

[bed_mesh]
speed: 400
mesh_min: 30,30
mesh_max: 270, 270
probe_count: 50,50
fade_start: 1.0
fade_end: 10.0
algorithm: bicubic
bicubic_tension: .2
horizontal_move_z: 10
#relative_reference_index: 12

#[probe]
#pin: EBBCan: PB6
#x_offset: 0
#y_offset: 0
#z_offset: 0
#speed: 3.0
#samples: 3
#samples_result: median
#sample_retract_dist: 3.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 5
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}
    

[safe_z_home]
##	XY Location of the Z Endstop Switch
##	Update -10,-10 to the XY coordinates of your endstop pin 
##	(such as 157,305) after going through Z Endstop Pin
##	Location Definition step.
home_xy_position:150,150
speed:100
z_hop:10

#####################################################################
#   Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
##  Connected to MOTOR_2
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32
endstop_pin: probe:z_virtual_endstop
#position_endstop: -0.5
position_max: 260
position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 0

[tmc2209 stepper_z]
uart_pin: PC6
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z1 Stepper - Rear Left
##  Connected to MOTOR_3
[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z2 Stepper - Rear Right
##  Connected to MOTOR_4
[stepper_z2]
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z3 Stepper - Front Right
##  Connected to MOTOR_5
[stepper_z3]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z3]
uart_pin: PE4
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 29.199
#*# pid_ki = 1.497
#*# pid_kd = 142.346
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.024657, 0.031194, 0.029213, 0.023977, 0.021689, 0.021402, 0.020509, 0.026493, 0.026993, 0.028231, 0.031421, 0.027398, 0.029527, 0.028006, 0.025838, 0.028267, 0.026612, 0.029710, 0.028646, 0.027960, 0.024390, 0.023016, 0.020983, 0.023072, 0.022378, 0.025718, 0.026790, 0.030504
#*# 	  0.028705, 0.022425, 0.020674, 0.023992, 0.021907, 0.024754, 0.026228, 0.031258, 0.029458, 0.032134, 0.029563, 0.028671, 0.027931, 0.026288, 0.028597, 0.026426, 0.031472, 0.030017, 0.033259, 0.027715, 0.029203, 0.025419, 0.027765, 0.025753, 0.028443, 0.033751, 0.037234, 0.037598
#*# 	  0.036962, 0.032550, 0.025955, 0.026498, 0.026129, 0.024756, 0.026901, 0.030123, 0.033116, 0.031050, 0.030979, 0.027057, 0.027813, 0.027163, 0.027795, 0.030298, 0.028229, 0.030611, 0.030455, 0.029720, 0.028022, 0.027935, 0.024626, 0.027648, 0.026704, 0.028416, 0.029799, 0.031712
#*# 	  0.030957, 0.023638, 0.022537, 0.023798, 0.021879, 0.025213, 0.026784, 0.030543, 0.027362, 0.027977, 0.026594, 0.028951, 0.028181, 0.026934, 0.028939, 0.026772, 0.026673, 0.026389, 0.030191, 0.026920, 0.028498, 0.024848, 0.028166, 0.028296, 0.029956, 0.032603, 0.036850, 0.034750
#*# 	  0.038373, 0.035766, 0.027046, 0.025290, 0.025722, 0.022977, 0.025580, 0.027504, 0.029099, 0.026908, 0.028455, 0.026348, 0.026955, 0.023653, 0.025463, 0.024805, 0.025059, 0.025475, 0.028759, 0.028770, 0.026441, 0.024547, 0.025353, 0.026249, 0.026297, 0.027530, 0.028698, 0.030818
#*# 	  0.029637, 0.022683, 0.020641, 0.020939, 0.020395, 0.021846, 0.025229, 0.024709, 0.024044, 0.024864, 0.023400, 0.024694, 0.024994, 0.023909, 0.025772, 0.023693, 0.024107, 0.023145, 0.025802, 0.024056, 0.025780, 0.024386, 0.027774, 0.026999, 0.030098, 0.031686, 0.036574, 0.032791
#*# 	  0.036109, 0.032065, 0.019334, 0.023083, 0.023222, 0.020837, 0.022409, 0.022773, 0.022122, 0.024449, 0.023615, 0.021366, 0.024298, 0.022641, 0.022864, 0.024112, 0.024601, 0.023127, 0.021003, 0.022326, 0.022217, 0.022754, 0.023049, 0.025306, 0.024435, 0.027851, 0.026674, 0.029245
#*# 	  0.026676, 0.020458, 0.018577, 0.019217, 0.021189, 0.019863, 0.020705, 0.019657, 0.017795, 0.019571, 0.018627, 0.018123, 0.020736, 0.020057, 0.022604, 0.020706, 0.020396, 0.017677, 0.020197, 0.019175, 0.023121, 0.023401, 0.025369, 0.025792, 0.027482, 0.028599, 0.031766, 0.029150
#*# 	  0.033662, 0.032289, 0.023842, 0.023826, 0.022834, 0.019474, 0.020074, 0.019342, 0.019535, 0.020984, 0.022363, 0.018827, 0.022598, 0.020533, 0.022772, 0.023631, 0.021715, 0.021073, 0.023306, 0.021565, 0.022360, 0.022367, 0.021776, 0.023349, 0.022895, 0.023153, 0.024541, 0.025078
#*# 	  0.025430, 0.019580, 0.018327, 0.019133, 0.018321, 0.018015, 0.018660, 0.016925, 0.017459, 0.018025, 0.019263, 0.019280, 0.021010, 0.020646, 0.022199, 0.019671, 0.020670, 0.019683, 0.022088, 0.019008, 0.019910, 0.020506, 0.022715, 0.021886, 0.024171, 0.024520, 0.028245, 0.024838
#*# 	  0.028188, 0.029102, 0.019097, 0.021721, 0.019865, 0.017862, 0.016572, 0.016499, 0.017752, 0.016785, 0.019214, 0.018225, 0.018192, 0.017131, 0.017314, 0.016884, 0.016211, 0.017711, 0.017163, 0.015759, 0.014557, 0.014404, 0.015654, 0.014797, 0.015926, 0.016099, 0.017387, 0.016884
#*# 	  0.018819, 0.012933, 0.013145, 0.015091, 0.012700, 0.013367, 0.013872, 0.012187, 0.013074, 0.012591, 0.014667, 0.014460, 0.016488, 0.014069, 0.016888, 0.015121, 0.014179, 0.014013, 0.016359, 0.012538, 0.014829, 0.013225, 0.014360, 0.013925, 0.016516, 0.016917, 0.021042, 0.018760
#*# 	  0.023560, 0.022770, 0.017613, 0.018659, 0.016226, 0.013473, 0.014963, 0.014416, 0.015160, 0.016307, 0.016832, 0.015633, 0.016832, 0.015010, 0.014702, 0.016563, 0.017436, 0.015184, 0.017213, 0.014471, 0.012541, 0.012300, 0.012483, 0.014169, 0.014353, 0.014585, 0.015325, 0.016365
#*# 	  0.020515, 0.014199, 0.012329, 0.014366, 0.014084, 0.013366, 0.014280, 0.013700, 0.013990, 0.014978, 0.014401, 0.015276, 0.017651, 0.014471, 0.018485, 0.018100, 0.017421, 0.016967, 0.018798, 0.016007, 0.017156, 0.017442, 0.019020, 0.019058, 0.019416, 0.024805, 0.025455, 0.025619
#*# 	  0.027808, 0.026024, 0.022478, 0.020188, 0.021659, 0.017029, 0.017862, 0.020788, 0.019175, 0.020153, 0.020361, 0.019347, 0.020733, 0.019389, 0.020920, 0.022375, 0.022209, 0.022280, 0.022148, 0.019399, 0.019735, 0.019892, 0.019569, 0.022209, 0.021959, 0.023102, 0.023577, 0.023892
#*# 	  0.025396, 0.021211, 0.018927, 0.020572, 0.019090, 0.018794, 0.020964, 0.018711, 0.018020, 0.018551, 0.018403, 0.020140, 0.024129, 0.021454, 0.025786, 0.023184, 0.022506, 0.021768, 0.024728, 0.020917, 0.023281, 0.023572, 0.025303, 0.026926, 0.026645, 0.030626, 0.033757, 0.031902
#*# 	  0.031608, 0.030432, 0.025862, 0.025894, 0.025991, 0.021623, 0.022515, 0.022918, 0.022095, 0.024458, 0.024151, 0.023891, 0.023272, 0.022903, 0.023228, 0.025627, 0.024212, 0.025596, 0.025618, 0.024576, 0.025120, 0.024235, 0.024938, 0.026987, 0.027005, 0.028536, 0.030384, 0.031378
#*# 	  0.028881, 0.022628, 0.023424, 0.024890, 0.024686, 0.024262, 0.024194, 0.024342, 0.023423, 0.024584, 0.024477, 0.024603, 0.026599, 0.024477, 0.026200, 0.023407, 0.024049, 0.024415, 0.027498, 0.026527, 0.028716, 0.029075, 0.030519, 0.031805, 0.034646, 0.036848, 0.039142, 0.038628
#*# 	  0.037639, 0.038070, 0.033308, 0.034377, 0.033194, 0.031154, 0.030940, 0.031673, 0.032567, 0.032756, 0.034173, 0.032110, 0.031746, 0.029952, 0.028889, 0.028530, 0.030257, 0.029392, 0.032813, 0.031385, 0.031982, 0.034136, 0.033623, 0.034937, 0.036296, 0.038126, 0.039458, 0.040217
#*# 	  0.034687, 0.028596, 0.029402, 0.031819, 0.031710, 0.029654, 0.029729, 0.031255, 0.030760, 0.031817, 0.031435, 0.031886, 0.032440, 0.030471, 0.032694, 0.031028, 0.032497, 0.031433, 0.034341, 0.034779, 0.036135, 0.037818, 0.039461, 0.039317, 0.042144, 0.046245, 0.047820, 0.047753
#*# 	  0.039063, 0.037700, 0.034014, 0.034263, 0.033038, 0.031044, 0.030185, 0.031430, 0.031581, 0.031244, 0.031948, 0.031035, 0.031208, 0.030994, 0.030149, 0.031552, 0.032407, 0.033725, 0.033971, 0.034098, 0.034489, 0.034293, 0.036120, 0.037452, 0.036839, 0.037855, 0.041266, 0.044041
#*# x_count = 28
#*# y_count = 21
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 85.11
#*# max_x = 213.04
#*# min_y = 100.87
#*# max_y = 197.87
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 60.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 33.2
#*#
#*# [probe]
#*# z_offset = -0.406
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 3500
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.030
#*#
#*# [scanner model default]
#*# model_coef = 1.304638523172017,
#*# 	1.7374035060827941,
#*# 	0.7341872326515386,
#*# 	0.2258223273809358,
#*# 	0.530638221764104,
#*# 	0.933409248722835,
#*# 	-0.4584319251599549,
#*# 	-1.0069357321670849,
#*# 	0.43831820488765894,
#*# 	0.5614274819752874
#*# model_domain = 3.1399926596483523e-07,3.358186350750966e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 26.134845
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
