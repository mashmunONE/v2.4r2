#Test
# This file contains common pin mappings for the BigTreeTech Octopus V1.
# This file contains common pin mappings for the BigTreeTech Octopus V1.
# To use this config, the firmware should be compiled for the STM32F446 with a "32KiB bootloader"
# Enable "extra low-level configuration options" and select the "12MHz crystal" as clock reference

# after running "make", copy the generated "klipper/out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the OctoPus with that SD card.

# See docs/Config_Reference.md for a description of parameters.

#####################################################################
#   Includes
#####################################################################
[include shell_command.cfg]
[include mainsail.cfg]
[include sb2209_usb.cfg]
[include stealthburner_leds.cfg]
[include btt_sff.cfg]
[include adaptive_mesh.cfg]
[include voron_purge.cfg]
[include nevermore.cfg]
[include macros.cfg]
[include timelapse.cfg]
[include TEST_SPEED.cfg]
[include macros/*.cfg]

#####################################################################
# Diverses
#####################################################################

[exclude_object]

#####################################################################
# Main
#####################################################################

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
##--------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_29002D001050334636383920-if00
restart_method: command
##--------------------------------------------------------------------

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 10000             #Max 4000
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

#####################################################################
#   Probe
#########¦¦¦¦¦¦######################################################

[mcu scanner]
#canbus_uuid: 9dcc262196d7 
serial: /dev/serial/by-id/usb-Cartographer_614e_028008000F43304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 15                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01586
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 1
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 150, 150    
#    set this to the middle of your bed
speed: 500
#    movement speed of toolhead during bed mesh
horizontal_move_z: 5
#    height of scanner during bed mesh scan
mesh_min: 35, 6
#    start point of bed mesh [X, Y]
mesh_max: 240, 198
#    end point of bed mesh [X, Y]
probe_count: 50, 50
algorithm: bicubic


#####################################################################
#   Extruder
#####################################################################


[extruder]
step_pin: EBB:gpio18
dir_pin: EBB:gpio19
enable_pin: !EBB:gpio17
gear_ratio: 50:10
microsteps: 16
rotation_distance: 21.545003545 
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_cross_section: 7
heater_pin: EBB:gpio7
pullup_resistor: 2200 # 2.2K
sensor_type: EPCOS 100K B57560G104F
sensor_pin: EBB:gpio26
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 270



#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  B Stepper - Left
##  Connected to MOTOR_0
##  Endstop connected to DIAG_0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  #set to 400 for 0.9 degree stepper
endstop_pin: EBB:gpio13
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 75   #Max 100
homing_retract_dist: 5
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PC4
interpolate: false
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0

##  A Stepper - Right
##  Connected to MOTOR_1
##  Endstop connected to DIAG_1
[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  #set to 400 for 0.9 degree stepper
endstop_pin: PG9
position_min: 0
position_endstop: 305
position_max: 305
homing_speed: 75  #Max 100
homing_retract_dist: 5
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_y]
uart_pin: PD11
interpolate: false
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0
 



#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA3
sensor_type:Generic 3950
sensor_pin: PF3
max_power: 1.0
min_temp: 0
max_temp: 120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769

#####################################################################
#   Fan Control
#####################################################################

[temperature_fan Octopus]
sensor_type: temperature_mcu
pin: PA8
max_temp: 80.0
target_temp: 40.0
min_temp: 0
shutdown_speed: 0.0
kick_start_time: 0.5
off_below: 0.19
max_speed: 1.0
min_speed: 0.0
control: pid
pid_Kp: 2.0
pid_Ki: 5.0
pid_Kd: 0.5
pid_deriv_time: 2.0

[temperature_fan Raspberry]
sensor_type: temperature_host
pin: PA5
max_temp: 80.0
target_temp: 35.0
min_temp: 10.0
shutdown_speed: 0.0
kick_start_time: 0.5
off_below: 0.19
max_speed: 1.0
min_speed: 0.0
control: pid
pid_Kp: 2.0
pid_Ki: 5.0
pid_Kd: 0.5
pid_deriv_time: 2.0

#[fan_generic electronic_bay]
#pin: PD12
#max_power:1
#shutdown_speed:
#cycle_time:
#hardware_pwm:
#kick_start_time:
#off_below:
#tachometer_pin:
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:
#   See the "fan" section for a description of the above parameters.

#####################################################################
#   Temperatures
#####################################################################

[temperature_sensor Raspberry_CPU]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

#[temperature_sensor Octopus_CPU]
#sensor_type: temperature_mcu
#min_temp: 0
#max_temp: 100

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[quad_gantry_level]
gantry_corners:
   -60,-10
   360,370
points:
   50,25
   50,225
   250,225
   250,25
speed: 400
horizontal_move_z: 5
retries: 6
retry_tolerance: 0.0075
max_adjust: 8

[bed_mesh]
speed: 400
mesh_min: 30,30
mesh_max: 270, 270
probe_count: 50,50
fade_start: 1.0
fade_end: 10.0
algorithm: bicubic
bicubic_tension: .2
horizontal_move_z: 10
#relative_reference_index: 12

#[probe]
#pin: EBBCan: PB6
#x_offset: 0
#y_offset: 0
#z_offset: 0
#speed: 3.0
#samples: 3
#samples_result: median
#sample_retract_dist: 3.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 5
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}
    

[safe_z_home]
##	XY Location of the Z Endstop Switch
##	Update -10,-10 to the XY coordinates of your endstop pin 
##	(such as 157,305) after going through Z Endstop Pin
##	Location Definition step.
home_xy_position:150,150
speed:100
z_hop:10

#####################################################################
#   Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
##  Connected to MOTOR_2
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32
endstop_pin: probe:z_virtual_endstop
#position_endstop: -0.5
position_max: 260
position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 0

[tmc2209 stepper_z]
uart_pin: PC6
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z1 Stepper - Rear Left
##  Connected to MOTOR_3
[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z2 Stepper - Rear Right
##  Connected to MOTOR_4
[stepper_z2]
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z3 Stepper - Front Right
##  Connected to MOTOR_5
[stepper_z3]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z3]
uart_pin: PE4
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.859
#*# pid_ki = 1.112
#*# pid_kd = 150.301
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.046089, 0.047793, 0.049563, 0.055047, 0.060877, 0.065452, 0.058661, 0.055373, 0.049714, 0.052917, 0.052874, 0.053781, 0.052098, 0.053985, 0.045053, 0.043433, 0.045900, 0.038366, 0.038368, 0.040540, 0.035999, 0.038320, 0.035376, 0.038889, 0.040419, 0.040757, 0.041376, 0.038449
#*# 	  0.052063, 0.037083, 0.039207, 0.041953, 0.046712, 0.050811, 0.049445, 0.040937, 0.039208, 0.039905, 0.041440, 0.039173, 0.042736, 0.043407, 0.041701, 0.043539, 0.045601, 0.045101, 0.043367, 0.044677, 0.042326, 0.045182, 0.047672, 0.053306, 0.055352, 0.057167, 0.060124, 0.060190
#*# 	  0.060429, 0.068678, 0.059994, 0.060288, 0.057529, 0.061501, 0.067646, 0.071191, 0.064051, 0.059910, 0.057207, 0.060125, 0.058989, 0.060900, 0.057027, 0.060130, 0.056653, 0.051422, 0.043394, 0.047990, 0.035174, 0.039753, 0.043753, 0.040173, 0.044886, 0.040289, 0.042651, 0.046458
#*# 	  0.040360, 0.045123, 0.045150, 0.039749, 0.033919, 0.037773, 0.042014, 0.047153, 0.047050, 0.041565, 0.039154, 0.038629, 0.040013, 0.043027, 0.040301, 0.044941, 0.043826, 0.044927, 0.043293, 0.043064, 0.042224, 0.046713, 0.047800, 0.049889, 0.053730, 0.055186, 0.058923, 0.059557
#*# 	  0.049610, 0.048452, 0.058408, 0.062074, 0.053830, 0.050995, 0.050732, 0.053539, 0.057697, 0.063393, 0.061100, 0.060291, 0.052246, 0.052819, 0.050131, 0.053296, 0.045646, 0.042608, 0.039673, 0.030919, 0.033403, 0.035851, 0.037971, 0.040987, 0.035083, 0.040450, 0.041661, 0.042495
#*# 	  0.024444, 0.026616, 0.031947, 0.038203, 0.029682, 0.027981, 0.026129, 0.028115, 0.030375, 0.036013, 0.039690, 0.038694, 0.035323, 0.032458, 0.031366, 0.033031, 0.033299, 0.033616, 0.033345, 0.034308, 0.035111, 0.034039, 0.040405, 0.040820, 0.046620, 0.047172, 0.049999, 0.050190
#*# 	  0.042319, 0.041633, 0.034043, 0.041297, 0.045952, 0.051147, 0.044297, 0.043088, 0.043297, 0.042934, 0.044140, 0.048258, 0.050684, 0.051955, 0.049058, 0.044508, 0.030870, 0.030679, 0.027402, 0.018725, 0.028070, 0.023771, 0.028736, 0.027105, 0.023075, 0.033420, 0.033279, 0.040702
#*# 	  0.019035, 0.016912, 0.017511, 0.013842, 0.020070, 0.024492, 0.023166, 0.018568, 0.019337, 0.019374, 0.020073, 0.020610, 0.021543, 0.026012, 0.029006, 0.029020, 0.027694, 0.025307, 0.026125, 0.027179, 0.026886, 0.028303, 0.027096, 0.032298, 0.040214, 0.045817, 0.047905, 0.047381
#*# 	  0.034731, 0.032777, 0.032871, 0.031461, 0.028333, 0.031160, 0.033399, 0.036622, 0.036854, 0.036082, 0.036035, 0.036485, 0.034740, 0.035735, 0.032109, 0.036280, 0.034375, 0.028707, 0.028062, 0.023954, 0.016315, 0.030079, 0.022524, 0.034429, 0.028646, 0.033201, 0.028017, 0.029432
#*# 	  0.022517, 0.020807, 0.023195, 0.017841, 0.017014, 0.015257, 0.017629, 0.017816, 0.021548, 0.020756, 0.022752, 0.020295, 0.020411, 0.023471, 0.024493, 0.027152, 0.028030, 0.029166, 0.030541, 0.034368, 0.033314, 0.032373, 0.032210, 0.033520, 0.034485, 0.037011, 0.037046, 0.038024
#*# 	  0.026563, 0.028837, 0.029038, 0.035282, 0.032628, 0.033479, 0.033631, 0.036767, 0.036074, 0.039062, 0.043189, 0.044560, 0.039506, 0.039582, 0.037156, 0.038211, 0.038693, 0.034402, 0.024812, 0.024761, 0.017173, 0.030096, 0.025016, 0.034037, 0.026364, 0.026576, 0.027709, 0.032680
#*# 	  0.006361, 0.002989, 0.008851, 0.009522, 0.008866, 0.004664, 0.007843, 0.007302, 0.009325, 0.009378, 0.014893, 0.017119, 0.019323, 0.020056, 0.018537, 0.017054, 0.018958, 0.020803, 0.021341, 0.022198, 0.021923, 0.024077, 0.025340, 0.029352, 0.035276, 0.041750, 0.046185, 0.049897
#*# 	  0.022070, 0.024089, 0.019733, 0.025902, 0.025606, 0.027372, 0.026394, 0.028536, 0.025086, 0.029010, 0.027476, 0.030869, 0.031935, 0.034915, 0.033745, 0.035669, 0.035550, 0.029863, 0.020622, 0.023304, 0.014245, 0.020969, 0.022162, 0.029053, 0.028947, 0.030891, 0.026841, 0.028221
#*# 	  0.012951, 0.006718, 0.007151, 0.008083, 0.008659, 0.007515, 0.008743, 0.006769, 0.008307, 0.007326, 0.010633, 0.010356, 0.014627, 0.014866, 0.016549, 0.018977, 0.020191, 0.023605, 0.026022, 0.028256, 0.030013, 0.030957, 0.031589, 0.031220, 0.032262, 0.030894, 0.034267, 0.035919
#*# 	  0.024505, 0.029273, 0.023823, 0.028749, 0.026023, 0.031081, 0.032586, 0.034789, 0.031104, 0.032105, 0.033373, 0.035635, 0.034719, 0.036235, 0.035699, 0.036015, 0.028148, 0.021343, 0.020647, 0.017285, 0.017368, 0.023144, 0.019302, 0.018972, 0.016965, 0.018696, 0.018311, 0.024311
#*# 	  0.001882, -0.001175, -0.001250, -0.001248, 0.000645, 0.002462, 0.008874, 0.009769, 0.009622, 0.007681, 0.008438, 0.009966, 0.010672, 0.009508, 0.010713, 0.013180, 0.012744, 0.014503, 0.016390, 0.014927, 0.016002, 0.018126, 0.024638, 0.031547, 0.034960, 0.034760, 0.037927, 0.039068
#*# 	  0.010899, 0.021476, 0.017717, 0.016416, 0.011349, 0.016676, 0.021417, 0.030450, 0.027352, 0.023290, 0.023330, 0.025172, 0.023693, 0.025969, 0.024473, 0.027181, 0.023912, 0.016485, 0.014139, 0.012397, 0.005968, 0.013401, 0.010047, 0.016831, 0.020887, 0.024775, 0.027672, 0.031211
#*# 	  0.000632, 0.005223, 0.008130, 0.001906, -0.000447, 0.000221, 0.006268, 0.013294, 0.013807, 0.007101, 0.007349, 0.006887, 0.009496, 0.010993, 0.012048, 0.013948, 0.012372, 0.015189, 0.014937, 0.016649, 0.016646, 0.016476, 0.017856, 0.022079, 0.023648, 0.027997, 0.030825, 0.031763
#*# 	  0.010090, 0.014575, 0.016882, 0.026861, 0.021037, 0.020793, 0.019343, 0.026400, 0.029773, 0.036248, 0.032791, 0.031054, 0.025500, 0.027601, 0.024516, 0.028166, 0.025597, 0.018465, 0.016047, 0.011765, 0.006123, 0.015359, 0.011469, 0.016064, 0.016693, 0.016863, 0.017461, 0.024438
#*# 	  0.000884, -0.002642, 0.005304, 0.012287, 0.011046, 0.005710, 0.004275, 0.006229, 0.011493, 0.016133, 0.020114, 0.020408, 0.015740, 0.012996, 0.012542, 0.014640, 0.015160, 0.016835, 0.016722, 0.020007, 0.018762, 0.018309, 0.018900, 0.021888, 0.023863, 0.024756, 0.028593, 0.034273
#*# 	  0.013033, 0.015705, 0.013591, 0.020712, 0.026205, 0.031565, 0.026320, 0.024764, 0.024196, 0.028383, 0.029138, 0.035716, 0.035870, 0.035764, 0.029767, 0.028762, 0.027144, 0.024304, 0.017018, 0.021510, 0.014362, 0.012953, 0.013292, 0.016124, 0.015279, 0.020104, 0.018603, 0.025564
#*# 	  0.000259, -0.001944, 0.000939, 0.003654, 0.010546, 0.013983, 0.011750, 0.006042, 0.008214, 0.008799, 0.008965, 0.010981, 0.012840, 0.014569, 0.015577, 0.016727, 0.014611, 0.013960, 0.014310, 0.014928, 0.016467, 0.016618, 0.020114, 0.022420, 0.026764, 0.029307, 0.033147, 0.029042
#*# 	  0.010670, 0.014640, 0.014207, 0.018175, 0.018164, 0.023456, 0.027569, 0.033274, 0.029720, 0.027591, 0.026076, 0.027367, 0.024879, 0.024021, 0.021696, 0.024315, 0.025532, 0.022651, 0.018281, 0.018315, 0.014014, 0.016322, 0.017312, 0.023276, 0.023849, 0.022202, 0.018358, 0.020200
#*# 	  0.002783, -0.000214, 0.003542, 0.004142, 0.005653, 0.003801, 0.007469, 0.012062, 0.018066, 0.017005, 0.014054, 0.012144, 0.012327, 0.012030, 0.012767, 0.012112, 0.012712, 0.013358, 0.014471, 0.016137, 0.018934, 0.020212, 0.022597, 0.024222, 0.024255, 0.024093, 0.029568, 0.029176
#*# 	  0.022530, 0.022786, 0.019103, 0.021566, 0.020792, 0.023599, 0.024442, 0.025748, 0.028511, 0.033370, 0.037931, 0.037996, 0.033430, 0.031377, 0.027897, 0.029957, 0.027641, 0.019801, 0.017616, 0.013959, 0.013086, 0.012780, 0.013110, 0.018144, 0.018414, 0.019306, 0.025075, 0.024629
#*# 	  0.010081, 0.012320, 0.013917, 0.010805, 0.007460, 0.006081, 0.010156, 0.010667, 0.015150, 0.013865, 0.018328, 0.019713, 0.021661, 0.020928, 0.019588, 0.020437, 0.018173, 0.017369, 0.015426, 0.016788, 0.016414, 0.017248, 0.017910, 0.023075, 0.027444, 0.034037, 0.033187, 0.032663
#*# 	  0.016112, 0.018760, 0.020940, 0.029811, 0.028993, 0.029450, 0.027061, 0.028006, 0.027776, 0.029480, 0.030456, 0.032244, 0.031027, 0.032713, 0.033034, 0.035603, 0.033937, 0.027063, 0.023632, 0.016624, 0.016736, 0.017789, 0.019180, 0.023411, 0.025852, 0.026453, 0.024587, 0.026678
#*# x_count = 28
#*# y_count = 27
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 84.83600000000001
#*# max_x = 216.334
#*# min_y = 86.255
#*# max_y = 213.315
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 55.6
#*# shaper_type_y = zv
#*# shaper_freq_y = 39.8
#*#
#*# [probe]
#*# z_offset = -0.406
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 3500
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.030
#*#
#*# [scanner model default]
#*# model_coef = 1.2905017396028269,
#*# 	1.7203222473054083,
#*# 	0.7576251341738619,
#*# 	0.2369916907534665,
#*# 	0.4219630464755113,
#*# 	0.8480363981947698,
#*# 	-0.25365927522377185,
#*# 	-0.8481022152401332,
#*# 	0.332692089957961,
#*# 	0.49345972703895385
#*# model_domain = 3.119238151424412e-07,3.3563012338234106e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 28.158560
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
