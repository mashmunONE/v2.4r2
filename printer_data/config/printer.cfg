#Test
# This file contains common pin mappings for the BigTreeTech Octopus V1.
# This file contains common pin mappings for the BigTreeTech Octopus V1.
# To use this config, the firmware should be compiled for the STM32F446 with a "32KiB bootloader"
# Enable "extra low-level configuration options" and select the "12MHz crystal" as clock reference

# after running "make", copy the generated "klipper/out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the OctoPus with that SD card.

# See docs/Config_Reference.md for a description of parameters.

#####################################################################
#   Includes
#####################################################################
[include shell_command.cfg]
[include mainsail.cfg]
[include SB2209.cfg]
[include stealthburner_leds.cfg]
[include adaptive_mesh.cfg]
[include voron_purge.cfg]
[include nevermore.cfg]
[include macros.cfg]
[include timelapse.cfg]
[include TEST_SPEED.cfg]
[include macros/*.cfg]

#####################################################################
# Diverses
#####################################################################

[exclude_object]

#####################################################################
# Main
#####################################################################

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
##--------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_29002D001050334636383920-if00
restart_method: command
##--------------------------------------------------------------------

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 10000             #Max 4000
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

#####################################################################
#   Probe
#########¦¦¦¦¦¦######################################################

[mcu scanner]
canbus_uuid: 9dcc262196d7 
#serial: /dev/serial/by-id/usb-cartographer_cartographer_
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 15                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01586
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 1
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 150, 150    
#    set this to the middle of your bed
speed: 500
#    movement speed of toolhead during bed mesh
horizontal_move_z: 5
#    height of scanner during bed mesh scan
mesh_min: 35, 6
#    start point of bed mesh [X, Y]
mesh_max: 240, 198
#    end point of bed mesh [X, Y]
probe_count: 50, 50
algorithm: bicubic


#####################################################################
#   Extruder
#####################################################################

[extruder]
step_pin: EBBCan: PD0
dir_pin: EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 16
rotation_distance: 22.840
gear_ratio: 50:10
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan: PB13
sensor_type: EPCOS 100K B57560G104F
sensor_pin: EBBCan: PA3
#control: pid
min_temp: 0
max_temp: 300
max_extrude_cross_section: 7
pressure_advance: 0.01
max_extrude_only_velocity: 500
max_extrude_only_distance: 101.0

[tmc2209 extruder]
uart_pin: EBBCan: PA15
run_current: 0.650
stealthchop_threshold: 999999


#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  B Stepper - Left
##  Connected to MOTOR_0
##  Endstop connected to DIAG_0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  #set to 400 for 0.9 degree stepper
endstop_pin: EBBCan: PB5
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 75   #Max 100
homing_retract_dist: 5
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PC4
interpolate: false
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0

##  A Stepper - Right
##  Connected to MOTOR_1
##  Endstop connected to DIAG_1
[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  #set to 400 for 0.9 degree stepper
endstop_pin: PG9
position_min: 0
position_endstop: 305
position_max: 305
homing_speed: 75  #Max 100
homing_retract_dist: 5
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_y]
uart_pin: PD11
interpolate: false
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0
 



#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA3
sensor_type:Generic 3950
sensor_pin: PF3
max_power: 1.0
min_temp: 0
max_temp: 120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769

#####################################################################
#   Fan Control
#####################################################################

[temperature_fan Octopus]
sensor_type: temperature_mcu
pin: PA8
max_temp: 80.0
target_temp: 40.0
min_temp: 0
shutdown_speed: 0.0
kick_start_time: 0.5
off_below: 0.19
max_speed: 1.0
min_speed: 0.0
control: pid
pid_Kp: 2.0
pid_Ki: 5.0
pid_Kd: 0.5
pid_deriv_time: 2.0

[temperature_fan Raspberry]
sensor_type: temperature_host
pin: PA5
max_temp: 80.0
target_temp: 35.0
min_temp: 10.0
shutdown_speed: 0.0
kick_start_time: 0.5
off_below: 0.19
max_speed: 1.0
min_speed: 0.0
control: pid
pid_Kp: 2.0
pid_Ki: 5.0
pid_Kd: 0.5
pid_deriv_time: 2.0

#####################################################################
#   Temperatures
#####################################################################

[temperature_sensor Raspberry_CPU]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

#[temperature_sensor Octopus_CPU]
#sensor_type: temperature_mcu
#min_temp: 0
#max_temp: 100

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[quad_gantry_level]
gantry_corners:
   -60,-10
   360,370
points:
   50,25
   50,225
   250,225
   250,25
speed: 400
horizontal_move_z: 5
retries: 6
retry_tolerance: 0.0075
max_adjust: 6

[bed_mesh]
speed: 400
mesh_min: 30,30
mesh_max: 270, 270
probe_count: 50,50
fade_start: 1.0
fade_end: 10.0
algorithm: bicubic
bicubic_tension: .2
horizontal_move_z: 10
#relative_reference_index: 12

#[probe]
#pin: EBBCan: PB6
#x_offset: 0
#y_offset: 0
#z_offset: 0
#speed: 3.0
#samples: 3
#samples_result: median
#sample_retract_dist: 3.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 5
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}
    

[safe_z_home]
##	XY Location of the Z Endstop Switch
##	Update -10,-10 to the XY coordinates of your endstop pin 
##	(such as 157,305) after going through Z Endstop Pin
##	Location Definition step.
home_xy_position:150,150
speed:100
z_hop:10

#####################################################################
#   Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
##  Connected to MOTOR_2
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32
endstop_pin: probe:z_virtual_endstop
#position_endstop: -0.5
position_max: 260
position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 0

[tmc2209 stepper_z]
uart_pin: PC6
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z1 Stepper - Rear Left
##  Connected to MOTOR_3
[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z2 Stepper - Rear Right
##  Connected to MOTOR_4
[stepper_z2]
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z3 Stepper - Front Right
##  Connected to MOTOR_5
[stepper_z3]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z3]
uart_pin: PE4
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_kp = 27.396
#*# pid_ki = 1.210
#*# pid_kd = 155.133
#*# control = pid
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.015051, 0.014894, 0.013614, 0.009770, 0.003997, 0.008875, 0.007613, 0.009806, 0.011488, 0.006849, 0.006967
#*# 	  0.017891, 0.014689, 0.012894, 0.006526, 0.008827, 0.011853, 0.010324, 0.013275, 0.008984, 0.009026, 0.008689
#*# 	  0.027485, 0.021075, 0.022132, 0.013925, 0.011403, 0.014514, 0.013412, 0.014895, 0.015348, 0.011158, 0.011215
#*# 	  0.025152, 0.022569, 0.017230, 0.012816, 0.015132, 0.016550, 0.016329, 0.019150, 0.015370, 0.014044, 0.013508
#*# 	  0.031865, 0.027672, 0.025467, 0.019175, 0.016303, 0.017639, 0.017874, 0.017769, 0.020840, 0.016351, 0.017588
#*# 	  0.029262, 0.026235, 0.020848, 0.016627, 0.018984, 0.021998, 0.022111, 0.022885, 0.019110, 0.017555, 0.018064
#*# 	  0.036962, 0.031982, 0.028985, 0.022816, 0.020878, 0.023068, 0.024551, 0.023251, 0.026897, 0.019248, 0.019061
#*# 	  0.032773, 0.028582, 0.025930, 0.019516, 0.023807, 0.026624, 0.025011, 0.026204, 0.024118, 0.021259, 0.020386
#*# 	  0.036612, 0.034562, 0.030543, 0.024100, 0.023885, 0.026397, 0.026601, 0.025628, 0.028465, 0.021347, 0.020422
#*# 	  0.032051, 0.028414, 0.024693, 0.020759, 0.025036, 0.026663, 0.026700, 0.027570, 0.023576, 0.019897, 0.019037
#*# 	  0.035383, 0.034348, 0.029042, 0.024984, 0.025128, 0.026792, 0.027783, 0.026456, 0.027631, 0.021013, 0.019553
#*# 	  0.033791, 0.026297, 0.025721, 0.019285, 0.025802, 0.027937, 0.026674, 0.027899, 0.024174, 0.018938, 0.018191
#*# 	  0.035183, 0.030693, 0.027161, 0.022401, 0.021857, 0.025870, 0.023729, 0.024804, 0.028143, 0.019161, 0.017720
#*# 	  0.031046, 0.023467, 0.021075, 0.016509, 0.021246, 0.024020, 0.022834, 0.025581, 0.021040, 0.016482, 0.016435
#*# 	  0.030102, 0.027768, 0.021229, 0.018138, 0.016108, 0.019484, 0.019964, 0.021703, 0.024396, 0.015942, 0.014066
#*# 	  0.024191, 0.018635, 0.017174, 0.011438, 0.016994, 0.018513, 0.018361, 0.021953, 0.017512, 0.014194, 0.012123
#*# 	  0.027444, 0.022660, 0.017854, 0.013980, 0.012357, 0.018266, 0.016681, 0.018025, 0.020428, 0.013662, 0.011159
#*# 	  0.019025, 0.013280, 0.012066, 0.006329, 0.013053, 0.015661, 0.016406, 0.016496, 0.013941, 0.010015, 0.009135
#*# 	  0.019874, 0.017332, 0.012883, 0.008757, 0.008473, 0.012732, 0.014222, 0.014517, 0.015230, 0.009034, 0.007493
#*# 	  0.013627, 0.010392, 0.008121, 0.004254, 0.009639, 0.011183, 0.012465, 0.013572, 0.010718, 0.005905, 0.005873
#*# 	  0.016502, 0.013276, 0.010887, 0.006234, 0.005231, 0.009752, 0.011079, 0.011148, 0.014501, 0.007503, 0.006154
#*# 	  0.010315, 0.006534, 0.004702, 0.001374, 0.006041, 0.009396, 0.008256, 0.011382, 0.009734, 0.005851, 0.005737
#*# 	  0.011897, 0.007824, 0.006925, 0.002085, 0.003187, 0.006710, 0.008076, 0.007808, 0.011475, 0.005813, 0.006038
#*# 	  0.006050, 0.002766, 0.000298, -0.001299, 0.001334, 0.006496, 0.006778, 0.008412, 0.007414, 0.005210, 0.002903
#*# 	  0.010457, 0.008037, 0.005331, 0.000392, 0.001650, 0.002882, 0.007619, 0.006585, 0.011239, 0.005090, 0.005417
#*# 	  0.007231, 0.001722, -0.000848, -0.003500, 0.000382, 0.004403, 0.003717, 0.009023, 0.007390, 0.004401, 0.004055
#*# 	  0.007309, 0.005453, 0.003568, -0.002678, -0.002893, 0.000488, 0.005025, 0.002933, 0.009813, 0.002853, 0.003847
#*# 	  0.003249, -0.001429, -0.000931, -0.005542, -0.004402, 0.001193, 0.000804, 0.005502, 0.003198, 0.001102, 0.000860
#*# 	  0.005497, 0.004136, 0.001849, -0.003661, -0.004545, -0.000335, 0.001731, 0.000608, 0.007810, 0.000461, -0.000856
#*# 	  0.003085, 0.000363, -0.003468, -0.007030, -0.003316, 0.000520, 0.000281, 0.002930, 0.001684, 0.000190, -0.000633
#*# 	  0.007125, 0.004290, 0.001534, -0.004250, -0.002709, -0.001424, 0.000531, 0.002390, 0.004378, 0.002120, 0.002421
#*# 	  0.004101, -0.000269, -0.003339, -0.006240, -0.002422, 0.000293, 0.001993, 0.006281, 0.004026, 0.001128, 0.002587
#*# 	  0.007298, 0.005962, 0.000104, -0.003425, -0.001808, 0.001654, 0.000471, 0.004141, 0.008155, 0.003035, 0.002833
#*# 	  0.005389, 0.001637, -0.000849, -0.003699, 0.001093, 0.003845, 0.003945, 0.007012, 0.008453, 0.003853, 0.004195
#*# 	  0.011346, 0.008194, 0.004232, 0.001966, 0.000685, 0.004831, 0.006370, 0.007134, 0.012383, 0.007827, 0.005505
#*# 	  0.009284, 0.004052, 0.003668, 0.001345, 0.005198, 0.006605, 0.008557, 0.011362, 0.009460, 0.007383, 0.008589
#*# 	  0.012602, 0.011674, 0.009016, 0.005913, 0.005446, 0.008367, 0.008434, 0.012210, 0.015458, 0.008728, 0.009752
#*# 	  0.011478, 0.007532, 0.006433, 0.003108, 0.008234, 0.010043, 0.011600, 0.014072, 0.013468, 0.009203, 0.011072
#*# 	  0.013604, 0.010490, 0.007231, 0.003840, 0.003180, 0.007952, 0.009519, 0.010715, 0.014278, 0.009611, 0.008635
#*# 	  0.007504, 0.003995, 0.002328, -0.000278, 0.002819, 0.006500, 0.009095, 0.010950, 0.008929, 0.006994, 0.007439
#*# 	  0.010184, 0.007850, 0.004436, 0.001049, -0.002080, 0.004119, 0.006935, 0.008892, 0.011553, 0.005869, 0.005313
#*# 	  0.005157, 0.001243, 0.000189, -0.003536, 0.000893, 0.003410, 0.005691, 0.007865, 0.006670, 0.004220, 0.005493
#*# 	  0.010497, 0.005322, 0.006080, 0.000218, -0.001271, 0.002909, 0.004628, 0.007351, 0.010116, 0.007232, 0.006578
#*# 	  0.004838, 0.001440, -0.000164, -0.002967, -0.000980, 0.001395, 0.004100, 0.005898, 0.006424, 0.004615, 0.006117
#*# 	  0.011165, 0.008354, 0.007494, 0.002340, -0.001145, 0.003559, 0.005393, 0.009026, 0.010900, 0.007734, 0.008230
#*# 	  0.006538, 0.003925, 0.002562, -0.002603, -0.000296, 0.003131, 0.005102, 0.008719, 0.009642, 0.007258, 0.008965
#*# 	  0.010796, 0.009109, 0.007982, 0.000814, -0.000348, 0.004564, 0.006110, 0.008189, 0.012019, 0.009031, 0.008469
#*# 	  0.007148, 0.003688, 0.001701, -0.002350, 0.000622, 0.005273, 0.005459, 0.009950, 0.010797, 0.007777, 0.010282
#*# 	  0.011921, 0.010310, 0.009327, 0.003304, 0.002472, 0.006876, 0.007776, 0.010472, 0.014595, 0.011601, 0.013423
#*# x_count = 11
#*# y_count = 49
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 124.11500000000001
#*# max_x = 172.70499999999998
#*# min_y = 31.38
#*# max_y = 266.07
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 55.0
#*# shaper_type_y = zv
#*# shaper_freq_y = 41.4
#*#
#*# [probe]
#*# z_offset = -0.406
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 3500
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.030
#*#
#*# [scanner model default]
#*# model_coef = 1.2905017396028269,
#*# 	1.7203222473054083,
#*# 	0.7576251341738619,
#*# 	0.2369916907534665,
#*# 	0.4219630464755113,
#*# 	0.8480363981947698,
#*# 	-0.25365927522377185,
#*# 	-0.8481022152401332,
#*# 	0.332692089957961,
#*# 	0.49345972703895385
#*# model_domain = 3.119238151424412e-07,3.3563012338234106e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 28.158560
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
