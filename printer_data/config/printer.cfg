#Test
# This file contains common pin mappings for the BigTreeTech Octopus V1.
# This file contains common pin mappings for the BigTreeTech Octopus V1.
# To use this config, the firmware should be compiled for the STM32F446 with a "32KiB bootloader"
# Enable "extra low-level configuration options" and select the "12MHz crystal" as clock reference

# after running "make", copy the generated "klipper/out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the OctoPus with that SD card.

# See docs/Config_Reference.md for a description of parameters.

#####################################################################
#   Includes
#####################################################################
[include shell_command.cfg]
[include mainsail.cfg]
[include sb2209_usb.cfg]
[include stealthburner_leds.cfg]
[include btt_sff.cfg]
[include adaptive_mesh.cfg]
[include voron_purge.cfg]
[include nevermore.cfg]
[include macros.cfg]
[include timelapse.cfg]
[include TEST_SPEED.cfg]
[include macros/*.cfg]

#####################################################################
# Diverses
#####################################################################

[exclude_object]

#####################################################################
# Main
#####################################################################

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
##--------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_29002D001050334636383920-if00
restart_method: command
##--------------------------------------------------------------------

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 10000             #Max 4000
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

#####################################################################
#   Probe
#########¦¦¦¦¦¦######################################################

[mcu scanner]
#canbus_uuid: 9dcc262196d7 
serial: /dev/serial/by-id/usb-Cartographer_614e_028008000F43304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 15                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01586
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 1
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 150, 150    
#    set this to the middle of your bed
speed: 500
#    movement speed of toolhead during bed mesh
horizontal_move_z: 5
#    height of scanner during bed mesh scan
mesh_min: 35, 6
#    start point of bed mesh [X, Y]
mesh_max: 240, 198
#    end point of bed mesh [X, Y]
probe_count: 50, 50
algorithm: bicubic


#####################################################################
#   Extruder
#####################################################################


[extruder]
step_pin: EBB:gpio18
dir_pin: EBB:gpio19
enable_pin: !EBB:gpio17
gear_ratio: 50:10
microsteps: 16
rotation_distance: 21.545003545 
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_cross_section: 7
heater_pin: EBB:gpio7
pullup_resistor: 2200 # 2.2K
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: EBB:gpio26
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 300



#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  B Stepper - Left
##  Connected to MOTOR_0
##  Endstop connected to DIAG_0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  #set to 400 for 0.9 degree stepper
endstop_pin: EBB:gpio13
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 75   #Max 100
homing_retract_dist: 5
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PC4
interpolate: false
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0

##  A Stepper - Right
##  Connected to MOTOR_1
##  Endstop connected to DIAG_1
[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  #set to 400 for 0.9 degree stepper
endstop_pin: PG9
position_min: 0
position_endstop: 305
position_max: 305
homing_speed: 75  #Max 100
homing_retract_dist: 5
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_y]
uart_pin: PD11
interpolate: false
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0
 



#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA3
sensor_type:Generic 3950
sensor_pin: PF3
max_power: 1.0
min_temp: 0
max_temp: 120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769

#####################################################################
#   Fan Control
#####################################################################

[temperature_fan Octopus]
sensor_type: temperature_mcu
pin: PA8
max_temp: 80.0
target_temp: 50.0
min_temp: 0
shutdown_speed: 0.0
kick_start_time: 0.5
off_below: 0.19
max_speed: 1.0
min_speed: 0.0
control: pid
pid_Kp: 2.0
pid_Ki: 5.0
pid_Kd: 0.5
pid_deriv_time: 2.0

[temperature_fan Raspberry]
sensor_type: temperature_host
pin: PE5
max_temp: 80.0
target_temp:50.0
min_temp: 10.0
shutdown_speed: 0.0
kick_start_time: 0.5
off_below: 0.19
max_speed: 1.0
min_speed: 0.0
control: pid
pid_Kp: 2.0
pid_Ki: 5.0
pid_Kd: 0.5
pid_deriv_time: 2.0

[fan_generic Electronics_Bay]
pin: PD13


#####################################################################
#   Temperatures
#####################################################################

[temperature_sensor Raspberry_CPU]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

#[temperature_sensor Octopus_CPU]
#sensor_type: temperature_mcu
#min_temp: 0
#max_temp: 100

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[quad_gantry_level]
gantry_corners:
   -60,-10
   360,370
points:
   50,25
   50,225
   250,225
   250,25
speed: 400
horizontal_move_z: 5
retries: 6
retry_tolerance: 0.0075
max_adjust: 8

[bed_mesh]
speed: 400
mesh_min: 30,30
mesh_max: 270, 270
probe_count: 50,50
fade_start: 1.0
fade_end: 10.0
algorithm: bicubic
bicubic_tension: .2
horizontal_move_z: 10
#relative_reference_index: 12

#[probe]
#pin: EBBCan: PB6
#x_offset: 0
#y_offset: 0
#z_offset: 0
#speed: 3.0
#samples: 3
#samples_result: median
#sample_retract_dist: 3.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 5
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}
    

[safe_z_home]
##	XY Location of the Z Endstop Switch
##	Update -10,-10 to the XY coordinates of your endstop pin 
##	(such as 157,305) after going through Z Endstop Pin
##	Location Definition step.
home_xy_position:150,150
speed:100
z_hop:10

#####################################################################
#   Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
##  Connected to MOTOR_2
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32
endstop_pin: probe:z_virtual_endstop
#position_endstop: -0.5
position_max: 260
position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 0

[tmc2209 stepper_z]
uart_pin: PC6
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z1 Stepper - Rear Left
##  Connected to MOTOR_3
[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z2 Stepper - Rear Right
##  Connected to MOTOR_4
[stepper_z2]
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999                                           

##  Z3 Stepper - Front Right
##  Connected to MOTOR_5
[stepper_z3]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z3]
uart_pin: PE4
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.859
#*# pid_ki = 1.112
#*# pid_kd = 150.301
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.083806, 0.086985, 0.089237, 0.085525, 0.091518, 0.086272, 0.078602, 0.075039, 0.071348, 0.071849, 0.068899, 0.069094, 0.067880, 0.066950, 0.066337, 0.065081, 0.064995, 0.064376, 0.064023, 0.060400, 0.062141, 0.060586, 0.061515, 0.063175, 0.062730, 0.065093, 0.062711
#*# 	  0.086500, 0.080558, 0.078717, 0.080004, 0.085498, 0.086440, 0.078275, 0.071648, 0.070040, 0.068380, 0.068597, 0.064929, 0.065947, 0.065110, 0.065461, 0.064175, 0.066412, 0.061580, 0.064203, 0.058215, 0.061633, 0.058810, 0.062920, 0.061520, 0.062413, 0.060973, 0.063731
#*# 	  0.098899, 0.095139, 0.082928, 0.082866, 0.077831, 0.083813, 0.085522, 0.083594, 0.072971, 0.072104, 0.069180, 0.070850, 0.068473, 0.066186, 0.066810, 0.065517, 0.066931, 0.063572, 0.060793, 0.057889, 0.058659, 0.059404, 0.058546, 0.060821, 0.057789, 0.061318, 0.057851
#*# 	  0.084770, 0.085870, 0.075252, 0.070010, 0.070063, 0.070102, 0.075121, 0.076680, 0.071463, 0.065285, 0.062491, 0.061945, 0.062302, 0.061506, 0.060076, 0.059585, 0.060931, 0.057488, 0.056723, 0.054796, 0.055252, 0.054392, 0.055570, 0.053677, 0.055942, 0.055713, 0.059744
#*# 	  0.077140, 0.081839, 0.083717, 0.078706, 0.067939, 0.065230, 0.065214, 0.066668, 0.071125, 0.072006, 0.067975, 0.062268, 0.058203, 0.056713, 0.055533, 0.057205, 0.055335, 0.053811, 0.051409, 0.048024, 0.049785, 0.049235, 0.048771, 0.048802, 0.048628, 0.050523, 0.050720
#*# 	  0.065463, 0.065022, 0.072355, 0.068958, 0.059709, 0.056246, 0.055872, 0.056320, 0.059320, 0.063096, 0.062251, 0.058470, 0.051632, 0.049974, 0.049677, 0.047048, 0.048211, 0.044972, 0.044032, 0.042153, 0.041211, 0.040557, 0.041920, 0.041958, 0.043233, 0.043238, 0.046214
#*# 	  0.074322, 0.065465, 0.060556, 0.067033, 0.066693, 0.062765, 0.055820, 0.052032, 0.055051, 0.051119, 0.054405, 0.055743, 0.056678, 0.054061, 0.047761, 0.044433, 0.042901, 0.040498, 0.038731, 0.037352, 0.036461, 0.036129, 0.034390, 0.036722, 0.035188, 0.036971, 0.038218
#*# 	  0.059870, 0.054507, 0.050906, 0.051179, 0.056487, 0.054781, 0.050387, 0.046425, 0.046101, 0.045096, 0.044022, 0.042056, 0.043508, 0.045523, 0.044592, 0.043225, 0.039619, 0.036040, 0.034479, 0.031365, 0.031113, 0.029483, 0.028063, 0.029099, 0.033660, 0.035713, 0.040711
#*# 	  0.064205, 0.061104, 0.053848, 0.051143, 0.045062, 0.046626, 0.048554, 0.046985, 0.046145, 0.043550, 0.041477, 0.040625, 0.037161, 0.036554, 0.033867, 0.038819, 0.037351, 0.036865, 0.032036, 0.029517, 0.028556, 0.028334, 0.025743, 0.030871, 0.030038, 0.033183, 0.028665
#*# 	  0.059401, 0.055985, 0.051723, 0.047353, 0.045146, 0.043141, 0.041403, 0.042904, 0.041218, 0.040510, 0.038218, 0.034722, 0.034952, 0.034656, 0.035268, 0.035519, 0.035599, 0.032408, 0.036172, 0.031212, 0.031524, 0.026401, 0.027552, 0.024030, 0.025547, 0.024098, 0.024273
#*# 	  0.055821, 0.057209, 0.053351, 0.054192, 0.046254, 0.046185, 0.044937, 0.042730, 0.044651, 0.044897, 0.045818, 0.041396, 0.037902, 0.034965, 0.032405, 0.033746, 0.033037, 0.032409, 0.027565, 0.028444, 0.026632, 0.029278, 0.024735, 0.024683, 0.020513, 0.020075, 0.018973
#*# 	  0.041864, 0.040948, 0.043981, 0.038386, 0.035810, 0.032844, 0.033977, 0.031852, 0.031502, 0.033172, 0.034535, 0.033989, 0.031267, 0.027888, 0.025380, 0.023444, 0.024202, 0.023815, 0.020941, 0.020245, 0.020251, 0.018125, 0.019167, 0.015926, 0.019917, 0.020494, 0.025814
#*# 	  0.048512, 0.046225, 0.040535, 0.044638, 0.038292, 0.036520, 0.032766, 0.032579, 0.029921, 0.027307, 0.029012, 0.029218, 0.029353, 0.029597, 0.026732, 0.026148, 0.021370, 0.019841, 0.016884, 0.016726, 0.014261, 0.015614, 0.010989, 0.013996, 0.013949, 0.017243, 0.014426
#*# 	  0.042767, 0.037817, 0.036336, 0.034774, 0.034425, 0.029954, 0.028107, 0.024643, 0.023781, 0.023645, 0.022411, 0.021897, 0.019928, 0.019578, 0.018694, 0.018782, 0.018548, 0.017959, 0.019312, 0.015718, 0.017054, 0.014569, 0.016560, 0.012992, 0.011166, 0.008366, 0.008721
#*# 	  0.048132, 0.047286, 0.038866, 0.040029, 0.036064, 0.038063, 0.034702, 0.031457, 0.029462, 0.026115, 0.025438, 0.024071, 0.024501, 0.021815, 0.020516, 0.016971, 0.014779, 0.013152, 0.013711, 0.013204, 0.011499, 0.008198, 0.003653, 0.002744, -0.001518, -0.001950, -0.000981
#*# 	  0.035840, 0.029790, 0.026827, 0.024790, 0.026730, 0.029104, 0.031305, 0.023864, 0.022716, 0.020185, 0.020138, 0.015901, 0.014668, 0.013159, 0.011711, 0.009962, 0.007243, 0.007864, 0.005198, 0.002012, 0.001474, 0.001376, 0.004693, 0.003809, 0.003392, 0.000746, 0.000354
#*# 	  0.039544, 0.041781, 0.026779, 0.025127, 0.019041, 0.022590, 0.027260, 0.027897, 0.020097, 0.016647, 0.013067, 0.013703, 0.010733, 0.009188, 0.007308, 0.007555, 0.004491, 0.001542, 0.001023, -0.002049, -0.007814, -0.007314, -0.008080, -0.001696, -0.000985, 0.001672, 0.000370
#*# 	  0.034790, 0.033798, 0.026541, 0.018196, 0.018261, 0.020822, 0.026201, 0.024377, 0.019344, 0.012909, 0.011729, 0.008863, 0.007792, 0.007144, 0.005647, 0.004581, 0.000964, -0.000804, -0.002240, -0.004927, -0.007254, -0.010429, -0.009205, -0.010206, -0.008148, -0.008262, -0.009038
#*# 	  0.032496, 0.036747, 0.033869, 0.032359, 0.020921, 0.020468, 0.019532, 0.024033, 0.025427, 0.023541, 0.017667, 0.011206, 0.008702, 0.005478, 0.004578, 0.002148, -0.000139, -0.004581, -0.005711, -0.009351, -0.010316, -0.011305, -0.014145, -0.012466, -0.015516, -0.013124, -0.016171
#*# 	  0.026161, 0.028718, 0.033740, 0.030584, 0.022169, 0.017325, 0.019015, 0.018164, 0.023197, 0.023615, 0.020034, 0.011370, 0.006543, 0.003656, 0.003104, -0.000210, -0.001005, -0.003837, -0.006495, -0.006740, -0.011480, -0.013435, -0.014800, -0.016233, -0.014434, -0.017897, -0.014855
#*# 	  0.031805, 0.029132, 0.024506, 0.031543, 0.029591, 0.025562, 0.017989, 0.015868, 0.015919, 0.014861, 0.016617, 0.017526, 0.013525, 0.005945, 0.000281, -0.002963, -0.003726, -0.007098, -0.008289, -0.008984, -0.011789, -0.016482, -0.019653, -0.019682, -0.023228, -0.022991, -0.023150
#*# 	  0.028138, 0.023610, 0.022969, 0.025091, 0.027092, 0.022680, 0.017206, 0.013498, 0.012460, 0.010368, 0.008487, 0.007055, 0.006093, 0.003283, 0.000907, -0.003568, -0.008832, -0.010692, -0.012780, -0.014741, -0.017539, -0.019766, -0.020794, -0.021485, -0.018475, -0.020119, -0.018836
#*# 	  0.030025, 0.029438, 0.021989, 0.022130, 0.019644, 0.022301, 0.022976, 0.017617, 0.011541, 0.007919, 0.004389, 0.001846, -0.001102, -0.006532, -0.007090, -0.007433, -0.007671, -0.012390, -0.013688, -0.016687, -0.018786, -0.021464, -0.021018, -0.022046, -0.022741, -0.024869, -0.028793
#*# 	  0.024734, 0.021667, 0.020244, 0.017099, 0.014756, 0.014140, 0.017155, 0.018349, 0.013005, 0.008524, 0.003378, 0.000754, -0.004125, -0.007120, -0.009890, -0.013579, -0.014050, -0.016225, -0.018047, -0.018381, -0.020663, -0.020633, -0.020735, -0.024718, -0.025868, -0.030702, -0.030462
#*# 	  0.028971, 0.027710, 0.019456, 0.018152, 0.013061, 0.012940, 0.009533, 0.010040, 0.011510, 0.012349, 0.007511, 0.002479, -0.003466, -0.007320, -0.009661, -0.012377, -0.016293, -0.020831, -0.023325, -0.026300, -0.027932, -0.029450, -0.031796, -0.031989, -0.035363, -0.036826, -0.035532
#*# 	  0.025802, 0.019929, 0.018196, 0.014299, 0.010778, 0.010095, 0.009277, 0.006939, 0.006665, 0.006996, 0.004882, 0.003384, -0.002261, -0.007067, -0.011969, -0.014840, -0.019209, -0.020999, -0.025458, -0.028186, -0.031577, -0.033182, -0.035297, -0.034882, -0.033043, -0.031358, -0.035462
#*# 	  0.024146, 0.023860, 0.012068, 0.015439, 0.011289, 0.009047, 0.006031, 0.005416, 0.002794, -0.000497, -0.003281, -0.004991, -0.006038, -0.008015, -0.009196, -0.012816, -0.016328, -0.022623, -0.027260, -0.032025, -0.035163, -0.037976, -0.037660, -0.037257, -0.037142, -0.039625, -0.041220
#*# x_count = 27
#*# y_count = 27
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 88.38419999999999
#*# max_x = 213.156
#*# min_y = 86.9554
#*# max_y = 212.655
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 55.6
#*# shaper_type_y = zv
#*# shaper_freq_y = 39.8
#*#
#*# [probe]
#*# z_offset = -0.406
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 3500
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.030
#*#
#*# [scanner model default]
#*# model_coef = 1.2905017396028269,
#*# 	1.7203222473054083,
#*# 	0.7576251341738619,
#*# 	0.2369916907534665,
#*# 	0.4219630464755113,
#*# 	0.8480363981947698,
#*# 	-0.25365927522377185,
#*# 	-0.8481022152401332,
#*# 	0.332692089957961,
#*# 	0.49345972703895385
#*# model_domain = 3.119238151424412e-07,3.3563012338234106e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 28.158560
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
